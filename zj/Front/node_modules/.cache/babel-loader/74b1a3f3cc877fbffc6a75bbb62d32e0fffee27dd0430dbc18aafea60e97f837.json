{"ast":null,"code":"import poster from \"@/assets/poster.gif\";\nimport usePeerStore from \"@/store/peer\";\nimport { onMounted, ref, watch } from \"vue\";\nimport { useRouter } from \"vue-router\";\nimport { showToast } from \"vant\";\nexport default {\n  __name: 'VideoCallAnswerView',\n  setup(__props, {\n    expose: __expose\n  }) {\n    __expose();\n    let mainVideo = ref();\n    let secondaryVideo = ref();\n    let localUserMedia = ref();\n    let peerStore = usePeerStore();\n    let router = useRouter();\n\n    //用于标记是否已经连接\n    let isConnected = ref(false);\n    onMounted(() => {\n      getLocalUserMedia({\n        audio: true,\n        video: true\n      }).then(userMedia => {\n        mainVideo.value.srcObject = userMedia;\n        localUserMedia.value = userMedia;\n        //先回应\n        peerStore.mediaConnection.answer(localUserMedia.value);\n        peerStore.mediaConnection.on(\"stream\", remoteUserMedia => {\n          mainVideo.value.srcObject = remoteUserMedia;\n          secondaryVideo.value.srcObject = localUserMedia.value;\n          isConnected.value = true;\n          showToast(\"connected\");\n        });\n      }).catch(() => {\n        showToast(\"failed to obtain local video media\");\n        router.back();\n      });\n    });\n\n    //监听对方挂断\n    let cancel = watch(() => [peerStore.dataConnection, peerStore.mediaConnection], ([dataConnection, mediaConnection]) => {\n      //两个连接都为空说明对方已经挂了\n      if (dataConnection === undefined && mediaConnection === undefined) {\n        cancel();\n        if (localUserMedia.value) {\n          for (let track of localUserMedia.value.getTracks()) {\n            track.stop();\n          }\n        }\n        showToast(\"the other party has hung up\");\n        router.back();\n      }\n    }, {\n      immediate: true\n    });\n    function getLocalUserMedia(constrains) {\n      if (window.navigator.mediaDevices.getUserMedia) {\n        return window.navigator.mediaDevices.getUserMedia(constrains);\n      } else if (window.navigator.webkitGetUserMedia) {\n        return window.navigator.webkitGetUserMedia(constrains);\n      } else if (window.navigator.mozGetUserMedia) {\n        return window.navigator.mozGetUserMedia(constrains);\n      } else if (window.navigator.getUserMedia) {\n        return window.navigator.getUserMedia(constrains);\n      }\n      throw new Error(\"unable to get user media\");\n    }\n\n    // 关闭视频通话\n    function ringOffVideoCall() {\n      //先取消上面的监听\n      cancel();\n      for (let track of (_localUserMedia$value = localUserMedia.value) === null || _localUserMedia$value === void 0 ? void 0 : _localUserMedia$value.getTracks()) {\n        var _localUserMedia$value;\n        track.stop();\n      }\n      peerStore.dataConnection.send({\n        instruction: peerStore.instruction.ringOff\n      });\n      peerStore.dataConnection = undefined;\n      peerStore.mediaConnection = undefined;\n      router.back();\n    }\n    const __returned__ = {\n      get mainVideo() {\n        return mainVideo;\n      },\n      set mainVideo(v) {\n        mainVideo = v;\n      },\n      get secondaryVideo() {\n        return secondaryVideo;\n      },\n      set secondaryVideo(v) {\n        secondaryVideo = v;\n      },\n      get localUserMedia() {\n        return localUserMedia;\n      },\n      set localUserMedia(v) {\n        localUserMedia = v;\n      },\n      get peerStore() {\n        return peerStore;\n      },\n      set peerStore(v) {\n        peerStore = v;\n      },\n      get router() {\n        return router;\n      },\n      set router(v) {\n        router = v;\n      },\n      get isConnected() {\n        return isConnected;\n      },\n      set isConnected(v) {\n        isConnected = v;\n      },\n      get cancel() {\n        return cancel;\n      },\n      set cancel(v) {\n        cancel = v;\n      },\n      getLocalUserMedia,\n      ringOffVideoCall,\n      get poster() {\n        return poster;\n      },\n      get usePeerStore() {\n        return usePeerStore;\n      },\n      onMounted,\n      ref,\n      watch,\n      get useRouter() {\n        return useRouter;\n      },\n      get showToast() {\n        return showToast;\n      }\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["poster","usePeerStore","onMounted","ref","watch","useRouter","showToast","mainVideo","secondaryVideo","localUserMedia","peerStore","router","isConnected","getLocalUserMedia","audio","video","then","userMedia","value","srcObject","mediaConnection","answer","on","remoteUserMedia","catch","back","cancel","dataConnection","undefined","track","getTracks","stop","immediate","constrains","window","navigator","mediaDevices","getUserMedia","webkitGetUserMedia","mozGetUserMedia","Error","ringOffVideoCall","_localUserMedia$value","send","instruction","ringOff"],"sources":["/Users/jiezhou/IdeaProjects/graduaction/zj/Front/src/views/VideoCallAnswerView.vue"],"sourcesContent":["<template>\n  <section class=\"container\">\n    <video class=\"main-video\" ref=\"mainVideo\" :poster=\"poster\" autoplay></video>\n    <video class=\"secondary-video\" ref=\"secondaryVideo\" :poster=\"poster\" autoplay></video>\n    <section class=\"bottom-bar\">\n      <van-button v-if=\"isConnected\" type=\"danger\" block @click=\"ringOffVideoCall\">\n        挂断视频通话\n      </van-button>\n    </section>\n  </section>\n</template>\n\n<script setup>\nimport poster from \"@/assets/poster.gif\";\nimport usePeerStore from \"@/store/peer\";\nimport {onMounted, ref, watch} from \"vue\";\nimport {useRouter} from \"vue-router\";\nimport {showToast} from \"vant\";\n\nlet mainVideo = ref();\nlet secondaryVideo = ref();\n\nlet localUserMedia = ref();\n\nlet peerStore = usePeerStore();\n\nlet router = useRouter();\n\n//用于标记是否已经连接\nlet isConnected = ref(false);\n\nonMounted(() => {\n  getLocalUserMedia({audio: true, video: true}).then(userMedia => {\n    mainVideo.value.srcObject = userMedia;\n    localUserMedia.value = userMedia;\n    //先回应\n    peerStore.mediaConnection.answer(localUserMedia.value);\n    peerStore.mediaConnection.on(\"stream\", remoteUserMedia => {\n      mainVideo.value.srcObject = remoteUserMedia;\n      secondaryVideo.value.srcObject = localUserMedia.value;\n      isConnected.value = true;\n      showToast(\"connected\");\n    });\n  }).catch(() => {\n    showToast(\"failed to obtain local video media\");\n    router.back();\n  });\n});\n\n//监听对方挂断\nlet cancel = watch(() => [peerStore.dataConnection, peerStore.mediaConnection], ([dataConnection, mediaConnection]) => {\n  //两个连接都为空说明对方已经挂了\n  if (dataConnection === undefined && mediaConnection === undefined) {\n    cancel();\n    if (localUserMedia.value) {\n      for (let track of localUserMedia.value.getTracks()) {\n        track.stop();\n      }\n    }\n    showToast(\"the other party has hung up\");\n    router.back();\n  }\n}, {immediate: true});\n\n\nfunction getLocalUserMedia(constrains) {\n  if (window.navigator.mediaDevices.getUserMedia) {\n    return window.navigator.mediaDevices.getUserMedia(constrains);\n  } else if (window.navigator.webkitGetUserMedia) {\n    return window.navigator.webkitGetUserMedia(constrains);\n  } else if (window.navigator.mozGetUserMedia) {\n    return window.navigator.mozGetUserMedia(constrains);\n  } else if (window.navigator.getUserMedia) {\n    return window.navigator.getUserMedia(constrains);\n  }\n  throw new Error(\"unable to get user media\");\n}\n\n// 关闭视频通话\nfunction ringOffVideoCall() {\n  //先取消上面的监听\n  cancel();\n  for (let track of localUserMedia.value?.getTracks()) {\n    track.stop();\n  }\n  peerStore.dataConnection.send({\n    instruction: peerStore.instruction.ringOff\n  });\n  peerStore.dataConnection = undefined;\n  peerStore.mediaConnection = undefined;\n  router.back();\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.container {\n  height: 100vh;\n  //background-color: black;\n  position: relative;\n\n  .secondary-video {\n    position: absolute;\n    z-index: 2;\n    border-radius: 0.625rem;\n    width: 30%;\n    top: 0.3125rem;\n    right: 0.3125rem;\n  }\n\n  .main-video {\n    position: absolute;\n    border-radius: 0.625rem;\n    width: 100%;\n    height: 100%;\n  }\n\n  .bottom-bar {\n    width: 100%;\n    position: absolute;\n    bottom: 0.625rem;\n  }\n}\n</style>"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}