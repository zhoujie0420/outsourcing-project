{"ast":null,"code":"import Peer from \"peerjs\";\nimport networkConfiguration from \"@/network/configuration\";\nimport usePeerStore from \"@/store/peer\";\nimport { showToast } from \"vant\";\nimport $ from \"jquery\";\nimport { apiUrl } from \"../../../config\";\nconst user = usePeerStore();\nexport default function initializePeer(id) {\n  let peerStore = usePeerStore();\n  let {\n    host,\n    port,\n    path\n  } = {\n    ...networkConfiguration.server.peerServer\n  };\n  let localPeer = new Peer(id, {\n    host,\n    port,\n    path\n  });\n  localPeer.on(\"connection\", dataConnection => {\n    console.log(\"localPeer on connection\", dataConnection);\n    if (peerStore.dataConnection) {\n      dataConnection.on(\"open\", () => {\n        dataConnection.send({\n          instruction: peerStore.instruction.busy\n        });\n      });\n    } else {\n      dataConnection.on(\"data\", data => {\n        console.log(\"dataConnection data\", data);\n        //请求通话\n        if (data.instruction === peerStore.instruction.request) {\n          peerStore.dataConnection = dataConnection;\n          //激活通知\n          peerStore.activateNotification = true;\n        }\n\n        //对方取消\n        else if (data.instruction === peerStore.instruction.cancel) {\n          //关闭数据连接\n          peerStore.dataConnection.close();\n          peerStore.dataConnection = undefined;\n          //取消激活通知\n          peerStore.activateNotification = false;\n        }\n\n        //对方挂断\n        else if (data.instruction === peerStore.instruction.ringOff) {\n          //关闭数据连接\n          peerStore.dataConnection.close();\n          peerStore.dataConnection = undefined;\n          //关闭媒体连接\n          peerStore.mediaConnection.close();\n          peerStore.mediaConnection = undefined;\n        }\n      });\n    }\n  });\n  localPeer.on(\"call\", mediaConnection => {\n    console.log(\"localPeer call\", mediaConnection);\n    addRecord(mediaConnection.peer, user.localPeer.id);\n    peerStore.mediaConnection = mediaConnection;\n  });\n  localPeer.on(\"disconnected\", () => {\n    console.warn(\"localPeer disconnected\");\n    localPeer.reconnect();\n    showToast(\"video call component disconnected\");\n  });\n  localPeer.on(\"error\", error => {\n    console.error(\"localPeer error,the error information is : \", JSON.stringify(error));\n    showToast(\"video call component error\");\n  });\n  localPeer.on(\"open\", localPeerId => {\n    console.log(\"localPeer opened,the local peer id is: \", localPeerId);\n    peerStore.localPeer = localPeer;\n  });\n}\nfunction addRecord(id1, id2) {\n  $.ajax({\n    url: `${apiUrl}/api/record/addRecord/`,\n    type: \"post\",\n    data: {\n      userId1: id1,\n      userId2: id2\n    },\n    headers: {\n      Authorization: \"Bearer \" + user.token\n    },\n    success(resp) {\n      if (resp.code === 200) {\n        console.log(resp.message);\n      } else {\n        console.log(resp.message);\n      }\n    },\n    error(resp) {\n      console.log(resp);\n    }\n  });\n}","map":{"version":3,"names":["Peer","networkConfiguration","usePeerStore","showToast","$","apiUrl","user","initializePeer","id","peerStore","host","port","path","server","peerServer","localPeer","on","dataConnection","console","log","send","instruction","busy","data","request","activateNotification","cancel","close","undefined","ringOff","mediaConnection","addRecord","peer","warn","reconnect","error","JSON","stringify","localPeerId","id1","id2","ajax","url","type","userId1","userId2","headers","Authorization","token","success","resp","code","message"],"sources":["/Users/jiezhou/IdeaProjects/graduaction/zj/Front/src/plugins/initialize-peer/index.js"],"sourcesContent":["import Peer from \"peerjs\";\nimport networkConfiguration from \"@/network/configuration\";\nimport usePeerStore from \"@/store/peer\";\nimport {showToast} from \"vant\";\nimport $ from \"jquery\";\nimport {apiUrl} from \"../../../config\";\n\n\nconst user = usePeerStore();\nexport default function initializePeer (id) {\n    let peerStore = usePeerStore();\n    let {host, port, path} = {...networkConfiguration.server.peerServer};\n    let localPeer = new Peer(id, {host, port, path});\n    localPeer.on(\"connection\", dataConnection => {\n        console.log(\"localPeer on connection\", dataConnection);\n        if (peerStore.dataConnection) {\n            dataConnection.on(\"open\", () => {\n                dataConnection.send({\n                    instruction: peerStore.instruction.busy\n                });\n            });\n        } else {\n            dataConnection.on(\"data\", data => {\n                console.log(\"dataConnection data\", data);\n                //请求通话\n                if (data.instruction === peerStore.instruction.request) {\n                    peerStore.dataConnection = dataConnection;\n                    //激活通知\n                    peerStore.activateNotification = true;\n                }\n\n                //对方取消\n                else if (data.instruction === peerStore.instruction.cancel) {\n                    //关闭数据连接\n                    peerStore.dataConnection.close();\n                    peerStore.dataConnection = undefined;\n                    //取消激活通知\n                    peerStore.activateNotification = false;\n                }\n\n                //对方挂断\n                else if (data.instruction === peerStore.instruction.ringOff) {\n                    //关闭数据连接\n                    peerStore.dataConnection.close();\n                    peerStore.dataConnection = undefined;\n                    //关闭媒体连接\n                    peerStore.mediaConnection.close();\n                    peerStore.mediaConnection = undefined;\n                }\n            });\n        }\n    });\n\n    localPeer.on(\"call\", mediaConnection => {\n        console.log(\"localPeer call\", mediaConnection);\n        addRecord(mediaConnection.peer,user.localPeer.id);\n        peerStore.mediaConnection = mediaConnection;\n    });\n\n    localPeer.on(\"disconnected\", () => {\n        console.warn(\"localPeer disconnected\");\n        localPeer.reconnect();\n        showToast(\"video call component disconnected\");\n    });\n\n    localPeer.on(\"error\", error => {\n        console.error(\"localPeer error,the error information is : \", JSON.stringify(error));\n        showToast(\"video call component error\");\n    });\n\n    localPeer.on(\"open\", localPeerId => {\n        console.log(\"localPeer opened,the local peer id is: \", localPeerId);\n        peerStore.localPeer = localPeer;\n    });\n}\n\nfunction addRecord(id1,id2) {\n    $.ajax({\n        url: `${apiUrl}/api/record/addRecord/`,\n        type: \"post\",\n        data: {\n            userId1: id1,\n            userId2: id2,\n        },\n        headers: {\n            Authorization: \"Bearer \" + user.token,\n        },\n        success(resp) {\n            if (resp.code === 200) {\n                console.log(resp.message)\n            } else {\n                console.log(resp.message)\n            }\n        },\n        error(resp) {\n            console.log(resp)\n        }\n    })\n}"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}